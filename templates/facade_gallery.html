{% extends "base.html" %}

{% block title %}å‡è±¡å›å»Š - å½’é€”çš„å…‰{% endblock %}

{% block content %}
<div class="card">
    <h2 style="text-align: center; margin-bottom: 30px; color: #ffd700;">å‡è±¡å›å»Š</h2>
    
    <div class="poetry">
        "è¯·è¿·æ‹æˆ‘ ä¸€èº«å‡è±¡"<br>
        "å¤©ä¸€äº® æˆ‘ä»¬åˆäººæ¨¡ç‹—æ ·"<br>
        "åœ¨è¿™é‡Œï¼Œåš24å°æ—¶çš„çœŸå®è‡ªå·±"
    </div>
    
    {% if not identity_token %}
    <div style="text-align: center; margin: 30px 0;">
        <p style="margin-bottom: 20px; font-size: 1.1rem;">
            åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åŒ¿åèº«ä»½ï¼Œåœ¨æ¥ä¸‹æ¥çš„24å°æ—¶å†…ï¼Œä½ å¯ä»¥è‡ªç”±è¡¨è¾¾å†…å¿ƒçš„å£°éŸ³ã€‚
        </p>
        <button onclick="createIdentity()" class="btn">åˆ›å»ºå‡è±¡èº«ä»½</button>
    </div>
    {% else %}
    <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #ffd700;">
        <p><strong>ä½ çš„å‡è±¡èº«ä»½å·²åˆ›å»º</strong></p>
        <p>å‰©ä½™æ—¶é—´: <span id="timeRemaining">{{ time_remaining }}</span></p>
        <small style="opacity: 0.7;">èº«ä»½å°†åœ¨24å°æ—¶åè‡ªåŠ¨æ¶ˆå¤±</small>
    </div>
    
    <form id="contentForm" method="post" action="/facade-gallery/create-content">
        <input type="hidden" name="identity_token" value="{{ identity_token }}">
        
        <div class="form-group">
            <label for="contentText">åˆ†äº«ä½ çš„å¿ƒç»ª</label>
            <textarea id="contentText" name="content_text" rows="6" placeholder="è®°å½•å½“ä¸‹çš„å¿ƒç»ªã€è§‚å¯Ÿæˆ–æ„Ÿæ‚Ÿ..." maxlength="1000"></textarea>
            <small style="color: rgba(240, 240, 240, 0.6);">è¿˜å¯ä»¥è¾“å…¥ <span id="charCount">1000</span> ä¸ªå­—ç¬¦</small>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="btn">å‘å¸ƒåˆ°å›å»Š</button>
        </div>
    </form>
    {% endif %}
</div>

<div class="card">
    <h3 style="color: #ffd700; margin-bottom: 20px; text-align: center;">å›å»Šæ¼«æ­¥</h3>
    <p style="text-align: center; margin-bottom: 30px; opacity: 0.8;">
        "æ”’è¿å¿ƒçš„é¼“æŒ" - åœ¨è¿™é‡Œï¼Œæ¯ä¸ªå£°éŸ³éƒ½å€¼å¾—è¢«å¬è§
    </p>
    
    <div id="galleryContents">
        {% if contents %}
            {% for content in contents %}
            <div class="content-item" style="background: rgba(255, 255, 255, 0.05); padding: 25px; margin-bottom: 20px; border-radius: 10px; border-left: 4px solid #ffed4e;">
                <div class="content-text" style="margin-bottom: 15px; line-height: 1.6;">
                    {{ content.content_text }}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; opacity: 0.7;">
                    <div>
                        <span>{{ content.created_at.strftime('%m-%d %H:%M') }}</span>
                        <span style="margin-left: 15px;">å‰©ä½™: {{ content.time_remaining }}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ‘ {{ content.applause_count }}</span>
                        <button onclick="applaud({{ content.id }})" class="applause-btn" style="background: none; border: 1px solid rgba(255, 255, 255, 0.3); color: #f0f0f0; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;">
                            é¼“æŒ
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; opacity: 0.7;">å›å»Šä¸­è¿˜æ²¡æœ‰å†…å®¹ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«è€…å§</p>
        {% endif %}
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="loadMoreContents()" class="btn" style="background: rgba(255, 255, 255, 0.1); color: #f0f0f0;">åŠ è½½æ›´å¤š</button>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.applause-btn:hover {
    background: rgba(255, 215, 0, 0.2) !important;
    border-color: #ffd700 !important;
    transform: scale(1.05);
}

.content-item {
    transition: all 0.3s ease;
}

.content-item:hover {
    background: rgba(255, 255, 255, 0.08) !important;
    transform: translateY(-2px);
}

@keyframes applauseAnimation {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.applause-animation {
    animation: applauseAnimation 0.3s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentOffset = {{ contents|length if contents else 0 }};

// å­—ç¬¦è®¡æ•°
document.getElementById('contentText')?.addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;
    const remaining = maxLength - currentLength;
    document.getElementById('charCount').textContent = remaining;
    
    if (remaining < 50) {
        document.getElementById('charCount').style.color = '#ff6b6b';
    } else {
        document.getElementById('charCount').style.color = 'rgba(240, 240, 240, 0.6)';
    }
});

// åˆ›å»ºå‡è±¡èº«ä»½
async function createIdentity() {
    try {
        const response = await fetch('/facade-gallery/create-identity', {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('åˆ›å»ºèº«ä»½å¤±è´¥: ' + error.detail);
        }
    } catch (error) {
        alert('åˆ›å»ºèº«ä»½å¤±è´¥: ' + error.message);
    }
}

// é¼“æŒ
async function applaud(contentId) {
    try {
        const response = await fetch(`/facade-gallery/applaud/${contentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            // æ›´æ–°é¼“æŒæ•°
            const contentItem = event.target.closest('.content-item');
            const applauseSpan = contentItem.querySelector('span');
            applauseSpan.textContent = `ğŸ‘ ${data.applause_count}`;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            event.target.classList.add('applause-animation');
            setTimeout(() => {
                event.target.classList.remove('applause-animation');
            }, 300);
            
            // ç¦ç”¨æŒ‰é’®
            event.target.disabled = true;
            event.target.textContent = 'å·²é¼“æŒ';
            event.target.style.opacity = '0.5';
        } else {
            const error = await response.json();
            if (error.detail.includes('å·²ç»é¼“æŒ')) {
                event.target.disabled = true;
                event.target.textContent = 'å·²é¼“æŒ';
                event.target.style.opacity = '0.5';
            } else {
                alert('é¼“æŒå¤±è´¥: ' + error.detail);
            }
        }
    } catch (error) {
        alert('é¼“æŒå¤±è´¥: ' + error.message);
    }
}

// åŠ è½½æ›´å¤šå†…å®¹
async function loadMoreContents() {
    try {
        const response = await fetch(`/facade-gallery/contents?offset=${currentOffset}&limit=10`);
        
        if (response.ok) {
            const data = await response.json();
            if (data.contents && data.contents.length > 0) {
                const galleryContents = document.getElementById('galleryContents');
                
                data.contents.forEach(content => {
                    const contentHtml = `
                        <div class="content-item" style="background: rgba(255, 255, 255, 0.05); padding: 25px; margin-bottom: 20px; border-radius: 10px; border-left: 4px solid #ffed4e;">
                            <div class="content-text" style="margin-bottom: 15px; line-height: 1.6;">
                                ${content.content_text}
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; opacity: 0.7;">
                                <div>
                                    <span>${new Date(content.created_at).toLocaleDateString('zh-CN', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</span>
                                    <span style="margin-left: 15px;">å‰©ä½™: ${content.time_remaining}</span>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>ğŸ‘ ${content.applause_count}</span>
                                    <button onclick="applaud(${content.id})" class="applause-btn" style="background: none; border: 1px solid rgba(255, 255, 255, 0.3); color: #f0f0f0; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;">
                                        é¼“æŒ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    galleryContents.insertAdjacentHTML('beforeend', contentHtml);
                });
                
                currentOffset += data.contents.length;
            } else {
                event.target.textContent = 'æ²¡æœ‰æ›´å¤šå†…å®¹äº†';
                event.target.disabled = true;
            }
        }
    } catch (error) {
        alert('åŠ è½½å¤±è´¥: ' + error.message);
    }
}

// æ›´æ–°å‰©ä½™æ—¶é—´ï¼ˆå¦‚æœæœ‰èº«ä»½ï¼‰
{% if identity_token %}
function updateTimeRemaining() {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶æ›´æ–°å‰©ä½™æ—¶é—´çš„é€»è¾‘
    // æš‚æ—¶çœç•¥ï¼Œå¯ä»¥é€šè¿‡WebSocketæˆ–å®šæ—¶åˆ·æ–°å®ç°
}
{% endif %}
</script>
{% endblock %}
